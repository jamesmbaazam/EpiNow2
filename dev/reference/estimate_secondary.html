<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="
Estimates the relationship between a primary and secondary observation, for
example hospital admissions and deaths or hospital admissions and bed
occupancy. See secondary_opts() for model structure options. See parameter
documentation for model defaults and options. See the examples for case studies
using synthetic data and here
for an example of forecasting Covid-19 deaths from Covid-19 cases. See
here for a prototype function that
may be used to estimate and forecast a secondary observation from a primary across multiple regions and
here
for an application forecasting Covid-19 deaths in Germany and Poland."><title>Estimate a Secondary Observation from a Primary Observation — estimate_secondary • EpiNow2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate a Secondary Observation from a Primary Observation — estimate_secondary"><meta property="og:description" content="
Estimates the relationship between a primary and secondary observation, for
example hospital admissions and deaths or hospital admissions and bed
occupancy. See secondary_opts() for model structure options. See parameter
documentation for model defaults and options. See the examples for case studies
using synthetic data and here
for an example of forecasting Covid-19 deaths from Covid-19 cases. See
here for a prototype function that
may be used to estimate and forecast a secondary observation from a primary across multiple regions and
here
for an application forecasting Covid-19 deaths in Germany and Poland."><meta property="og:image" content="epiforecasts.io/EpiNow2/reference/figures/unnamed-chunk-14-1.png"><meta property="og:image:alt" content="Example estimates produced by EpiNow2 of the reproduction number, cases by date of infection and cases by date of report"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@seabbs"><meta name="twitter:site" content="@cmmid_lshtm"><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">EpiNow2</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-model-definitions">Model definitions</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-model-definitions">
    <a class="dropdown-item" href="../articles/estimate_infections.html">estimate_infections()</a>
    <a class="dropdown-item" href="../articles/estimate_secondary.html">estimate_secondary()</a>
    <a class="dropdown-item" href="../articles/estimate_truncation.html">estimate_truncation()</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-case-studies">Case studies</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-case-studies">
    <a class="dropdown-item" href="../articles/case-studies.html">External case studies and use in the literature</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/epiforecasts/EpiNow2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Estimate a Secondary Observation from a Primary Observation</h1>
      <small class="dont-index">Source: <a href="https://github.com/epiforecasts/EpiNow2/blob/HEAD/R/estimate_secondary.R" class="external-link"><code>R/estimate_secondary.R</code></a></small>
      <div class="d-none name"><code>estimate_secondary.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a>
Estimates the relationship between a primary and secondary observation, for
example hospital admissions and deaths or hospital admissions and bed
occupancy. See <code><a href="secondary_opts.html">secondary_opts()</a></code> for model structure options. See parameter
documentation for model defaults and options. See the examples for case studies
using synthetic data and <a href="https://gist.github.com/seabbs/4f09d7609df298db7a86c31612ff9d17" class="external-link">here</a>
for an example of forecasting Covid-19 deaths from Covid-19 cases. See
<a href="https://gist.github.com/seabbs/4dad3958ca8d83daca8f02b143d152e6" class="external-link">here</a> for a prototype function that
may be used to estimate and forecast a secondary observation from a primary across multiple regions and
<a href="https://github.com/epiforecasts/covid.german.forecasts/blob/master/rt-forecast/death-from-cases.R" class="external-link">here</a>
for an application forecasting Covid-19 deaths in Germany and Poland.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">estimate_secondary</span><span class="op">(</span></span>
<span>  <span class="va">reports</span>,</span>
<span>  secondary <span class="op">=</span> <span class="fu"><a href="secondary_opts.html">secondary_opts</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  delays <span class="op">=</span> <span class="fu"><a href="delay_opts.html">delay_opts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">2.5</span>, mean_sd <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">0.47</span>, sd_sd <span class="op">=</span> <span class="fl">0.25</span>, max <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  truncation <span class="op">=</span> <span class="fu"><a href="trunc_opts.html">trunc_opts</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="obs_opts.html">obs_opts</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">14</span>,</span>
<span>  CrIs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>reports</dt>
<dd><p>A data frame containing the <code>date</code> of report and both <code>primary</code>
and <code>secondary</code> reports.</p></dd>


<dt>secondary</dt>
<dd><p>A call to <code><a href="secondary_opts.html">secondary_opts()</a></code> or a list containing the following
binary variables: cumulative, historic, primary_hist_additive, current,
primary_current_additive. These parameters control the structure of the
secondary model, see <code><a href="secondary_opts.html">secondary_opts()</a></code> for details.</p></dd>


<dt>delays</dt>
<dd><p>A call to <code><a href="delay_opts.html">delay_opts()</a></code> defining delay distributions between
primary and secondary observations See the documentation of <code><a href="delay_opts.html">delay_opts()</a></code> for
details. BY default a diffuse prior  is assumed with a mean of 14 days and
standard deviation of 7 days (with a standard deviation of 0.5 and 0.25 respectively
on the log scale).</p></dd>


<dt>truncation</dt>
<dd><p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a> A list of options as generated by <code><a href="trunc_opts.html">trunc_opts()</a></code>
defining the truncation of observed data. Defaults to <code><a href="trunc_opts.html">trunc_opts()</a></code>. See <code><a href="estimate_truncation.html">estimate_truncation()</a></code>
for an approach to estimating truncation from data.</p></dd>


<dt>obs</dt>
<dd><p>A list of options as generated by <code><a href="obs_opts.html">obs_opts()</a></code> defining the
observation model. Defaults to <code><a href="obs_opts.html">obs_opts()</a></code>.</p></dd>


<dt>burn_in</dt>
<dd><p>Integer, defaults to 14 days. The number of data points to use for
estimation but not to fit to at the beginning of the time series. This must be less
than the number of observations.</p></dd>


<dt>CrIs</dt>
<dd><p>Numeric vector of credible intervals to calculate.</p></dd>


<dt>model</dt>
<dd><p>A compiled stan model to override the default model. May be
useful for package developers or those developing extensions.</p></dd>


<dt>verbose</dt>
<dd><p>Logical, should model fitting progress be returned. Defaults to
<code><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive()</a></code>.</p></dd>


<dt>...</dt>
<dd><p>Additional parameters to pass to <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A list containing: <code>predictions</code> (a data frame ordered by date with the primary,
and secondary observations, and a summary of the model estimated secondary observations),
<code>data</code> (a list of data used to fit the model), and <code>fit</code> (the <code>stanfit</code> object).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># set number of cores to use</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#' # load data.table for manipulation</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># load lubridate for dates</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘lubridate’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:data.table’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     hour, isoweek, mday, minute, month, quarter, second, wday, week,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     yday, year</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:base’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     date, intersect, setdiff, union</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘purrr’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:data.table’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     transpose</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:EpiNow2’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     update_list</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Incidence data example ####</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># make some example secondary incidence data</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">example_confirmed</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span><span class="op">[</span>, <span class="va">primary</span> <span class="op">:=</span> <span class="va">confirm</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># Assume that only 40 percent of cases are reported</span></span></span>
<span class="r-in"><span><span class="va">cases</span><span class="op">[</span>, <span class="va">scaling</span> <span class="op">:=</span> <span class="fl">0.4</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            date confirm primary scaling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1: 2020-02-22      14      14     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2: 2020-02-23      62      62     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   3: 2020-02-24      53      53     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   4: 2020-02-25      97      97     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   5: 2020-02-26      93      93     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  ---                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 126: 2020-06-26     296     296     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 127: 2020-06-27     255     255     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 128: 2020-06-28     175     175     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 129: 2020-06-29     174     174     0.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 130: 2020-06-30     126     126     0.4</span>
<span class="r-in"><span><span class="co"># Parameters of the assumed log normal delay distribution</span></span></span>
<span class="r-in"><span><span class="va">cases</span><span class="op">[</span>, <span class="va">meanlog</span> <span class="op">:=</span> <span class="fl">1.8</span><span class="op">]</span><span class="op">[</span>, <span class="va">sdlog</span> <span class="op">:=</span> <span class="fl">0.5</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            date confirm primary scaling meanlog sdlog</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1: 2020-02-22      14      14     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2: 2020-02-23      62      62     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   3: 2020-02-24      53      53     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   4: 2020-02-25      97      97     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   5: 2020-02-26      93      93     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  ---                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 126: 2020-06-26     296     296     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 127: 2020-06-27     255     255     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 128: 2020-06-28     175     175     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 129: 2020-06-29     174     174     0.4     1.8   0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 130: 2020-06-30     126     126     0.4     1.8   0.5</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># apply a convolution of a log normal to a vector of observations</span></span></span>
<span class="r-in"><span><span class="va">weight_cmf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">meanlog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.6</span>, <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sdlog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cmf</span> <span class="op">&lt;-</span> <span class="va">cmf</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">plnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">cmf</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">conv</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">conv</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># roll over observed cases to produce a convolution</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">date</span>, primary <span class="op">=</span> <span class="va">confirm</span>, secondary <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/froll.html" class="external-link">frollapply</a></span><span class="op">(</span><span class="va">secondary</span>, <span class="fl">15</span>, <span class="va">weight_cmf</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">secondary</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># add a day of the week effect and scale secondary observations at 40\% of primary</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">wday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">secondary</span>, <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">secondary</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">0.4</span>, <span class="fl">0.025</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span><span class="va">secondary</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">secondary</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit model to example data assuming only a given fraction of primary observations</span></span></span>
<span class="r-in"><span><span class="co"># become secondary observations</span></span></span>
<span class="r-in"><span><span class="va">inc</span> <span class="op">&lt;-</span> <span class="fu">estimate_secondary</span><span class="op">(</span><span class="va">cases</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>  obs <span class="op">=</span> <span class="fu"><a href="obs_opts.html">obs_opts</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.2</span>, sd <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot.estimate_infections.html">plot</a></span><span class="op">(</span><span class="va">inc</span>, primary <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="estimate_secondary-1.png" alt="" width="864" height="864"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># forecast future secondary cases from primary</span></span></span>
<span class="r-in"><span><span class="va">inc_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast_secondary.html">forecast_secondary</a></span><span class="op">(</span><span class="va">inc</span>, <span class="va">cases</span><span class="op">[</span><span class="fl">61</span><span class="op">:</span><span class="va">.N</span><span class="op">]</span><span class="op">[</span>, <span class="va">value</span> <span class="op">:=</span> <span class="va">primary</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot.estimate_infections.html">plot</a></span><span class="op">(</span><span class="va">inc_preds</span>, new_obs <span class="op">=</span> <span class="va">cases</span>, from <span class="op">=</span> <span class="st">"2020-05-01"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="estimate_secondary-2.png" alt="" width="864" height="864"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Prevalence data example ####</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># make some example prevalence data</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">example_confirmed</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">date</span>,</span></span>
<span class="r-in"><span>  primary <span class="op">=</span> <span class="va">confirm</span>,</span></span>
<span class="r-in"><span>  scaled_primary <span class="op">=</span> <span class="va">confirm</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">0.4</span>, <span class="fl">0.05</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">cases</span><span class="op">$</span><span class="va">secondary</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></span>
<span class="r-in"><span><span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cases</span><span class="op">$</span><span class="va">scaled_primary</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">meanlog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.6</span>, <span class="fl">0.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sdlog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.8</span>, <span class="fl">0.05</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">19</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cmf</span> <span class="op">&lt;-</span> <span class="va">cmf</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">plnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span>, <span class="va">meanlog</span>, <span class="va">sdlog</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">reducing_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cases</span><span class="op">$</span><span class="va">scaled_primary</span><span class="op">[</span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">20</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">cmf</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">reducing_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">reducing_cases</span>,</span></span>
<span class="r-in"><span>    <span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">reducing_cases</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">cases</span><span class="op">$</span><span class="va">scaled_primary</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">reducing_cases</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>,</span></span>
<span class="r-in"><span>    <span class="va">cases</span><span class="op">$</span><span class="va">secondary</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span>, <span class="va">secondary</span> <span class="op">:=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">secondary</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit model to example prevalence data</span></span></span>
<span class="r-in"><span><span class="va">prev</span> <span class="op">&lt;-</span> <span class="fu">estimate_secondary</span><span class="op">(</span><span class="va">cases</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>  secondary <span class="op">=</span> <span class="fu"><a href="secondary_opts.html">secondary_opts</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"prevalence"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  obs <span class="op">=</span> <span class="fu"><a href="obs_opts.html">obs_opts</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    week_effect <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>    scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.3</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>There were 1 divergent transitions after warmup. See</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> to find out why this is a problem and how to eliminate them.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Examine the pairs() plot to diagnose sampling problems</span>
<span class="r-in"><span><span class="fu"><a href="plot.estimate_infections.html">plot</a></span><span class="op">(</span><span class="va">prev</span>, primary <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="estimate_secondary-3.png" alt="" width="864" height="864"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># forecast future secondary cases from primary</span></span></span>
<span class="r-in"><span><span class="va">prev_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast_secondary.html">forecast_secondary</a></span><span class="op">(</span><span class="va">prev</span>, <span class="va">cases</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="va">.N</span><span class="op">]</span><span class="op">[</span>, <span class="va">value</span> <span class="op">:=</span> <span class="va">primary</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot.estimate_infections.html">plot</a></span><span class="op">(</span><span class="va">prev_preds</span>, new_obs <span class="op">=</span> <span class="va">cases</span>, from <span class="op">=</span> <span class="st">"2020-06-01"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="estimate_secondary-4.png" alt="" width="864" height="864"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>, Joel Hellewell, Katharine Sherratt, Katelyn Gostic, Joe Hickson, Hamada S. Badr, Michael DeWitt, EpiForecasts, <a href="https://www.lshtm.ac.uk/aboutus/people/funk.sebastian" class="external-link">Sebastian Funk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.9000.</p>
</div>

    </footer></div>

  

  

  </body></html>

